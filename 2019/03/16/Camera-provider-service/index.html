<!DOCTYPE html>
<html lang="default">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.0.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" integrity="sha256-yIDrPSXHZdOZhAqiBP7CKzIwMQmRCJ8UeB8Jo17YC4o=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.19.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"بحث...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="Camera provider Service 启动流程引言本文整理Camera Provider Service的启动流程，代码基于Android8.x。 代码追踪启动脚本&#x61;&#x6e;&#100;&#x72;&#111;&#105;&#x64;&#x2e;&#x68;&#97;&#114;&#x64;&#x77;&#x61;&#x72;&#x65;&#46;&#x63;&#x61;&amp;">
<meta property="og:type" content="article">
<meta property="og:title" content="Camera provider service">
<meta property="og:url" content="http://example.com/2019/03/16/Camera-provider-service/index.html">
<meta property="og:site_name" content="Something">
<meta property="og:description" content="Camera provider Service 启动流程引言本文整理Camera Provider Service的启动流程，代码基于Android8.x。 代码追踪启动脚本&#x61;&#x6e;&#100;&#x72;&#111;&#105;&#x64;&#x2e;&#x68;&#97;&#114;&#x64;&#x77;&#x61;&#x72;&#x65;&#46;&#x63;&#x61;&amp;">
<meta property="og:locale">
<meta property="article:published_time" content="2019-03-16T12:19:08.000Z">
<meta property="article:modified_time" content="2019-03-16T12:24:10.774Z">
<meta property="article:author" content="Guo Xf">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://example.com/2019/03/16/Camera-provider-service/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"default","comments":true,"permalink":"http://example.com/2019/03/16/Camera-provider-service/","path":"2019/03/16/Camera-provider-service/","title":"Camera provider service"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Camera provider service | Something</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="تشغيل شريط التصفح" role="button">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Something</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="بحث" role="button">
    </div>
  </div>
</div>







</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          المحتويات
        </li>
        <li class="sidebar-nav-overview">
          عام
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#Camera-provider-Service-%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B"><span class="nav-number">1.</span> <span class="nav-text">Camera provider Service 启动流程</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BC%95%E8%A8%80"><span class="nav-number"></span> <span class="nav-text">引言</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%A3%E7%A0%81%E8%BF%BD%E8%B8%AA"><span class="nav-number">1.</span> <span class="nav-text">代码追踪</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B0%8F%E7%BB%93"><span class="nav-number"></span> <span class="nav-text">小结</span></a></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Guo Xf</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">14</span>
          <span class="site-state-item-name">المقالات</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">الوسوم</span>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="default">
    <link itemprop="mainEntityOfPage" href="http://example.com/2019/03/16/Camera-provider-service/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Guo Xf">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Something">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Camera provider service | Something">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Camera provider service
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">نُشر في</span>
      

      <time title="أُنشأ: 2019-03-16 20:19:08 / عُدل: 20:24:10" itemprop="dateCreated datePublished" datetime="2019-03-16T20:19:08+08:00">2019-03-16</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h3 id="Camera-provider-Service-启动流程"><a href="#Camera-provider-Service-启动流程" class="headerlink" title="Camera provider Service 启动流程"></a>Camera provider Service 启动流程</h3><h2 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h2><p>本文整理Camera Provider Service的启动流程，代码基于Android8.x。</p>
<h3 id="代码追踪"><a href="#代码追踪" class="headerlink" title="代码追踪"></a>代码追踪</h3><p>启动脚本<br><a href="mailto:&#x61;&#x6e;&#100;&#x72;&#111;&#105;&#x64;&#x2e;&#x68;&#97;&#114;&#x64;&#x77;&#x61;&#x72;&#x65;&#46;&#x63;&#x61;&#109;&#101;&#114;&#x61;&#46;&#112;&#x72;&#111;&#118;&#105;&#x64;&#x65;&#114;&#64;&#50;&#46;&#52;&#45;&#115;&#101;&#114;&#118;&#x69;&#x63;&#x65;&#x2e;&#114;&#x63;">&#x61;&#x6e;&#100;&#x72;&#111;&#105;&#x64;&#x2e;&#x68;&#97;&#114;&#x64;&#x77;&#x61;&#x72;&#x65;&#46;&#x63;&#x61;&#109;&#101;&#114;&#x61;&#46;&#112;&#x72;&#111;&#118;&#105;&#x64;&#x65;&#114;&#64;&#50;&#46;&#52;&#45;&#115;&#101;&#114;&#118;&#x69;&#x63;&#x65;&#x2e;&#114;&#x63;</a><br>会执行可执行程序&#x2F;vendor&#x2F;bin&#x2F;hw&#x2F;<a href="mailto:&#97;&#x6e;&#100;&#114;&#x6f;&#x69;&#100;&#46;&#104;&#97;&#x72;&#100;&#119;&#x61;&#x72;&#x65;&#x2e;&#99;&#97;&#x6d;&#x65;&#114;&#97;&#46;&#x70;&#114;&#x6f;&#x76;&#105;&#x64;&#101;&#114;&#x40;&#50;&#x2e;&#x34;&#x2d;&#115;&#x65;&#114;&#118;&#x69;&#x63;&#x65;">&#97;&#x6e;&#100;&#114;&#x6f;&#x69;&#100;&#46;&#104;&#97;&#x72;&#100;&#119;&#x61;&#x72;&#x65;&#x2e;&#99;&#97;&#x6d;&#x65;&#114;&#97;&#46;&#x70;&#114;&#x6f;&#x76;&#105;&#x64;&#101;&#114;&#x40;&#50;&#x2e;&#x34;&#x2d;&#115;&#x65;&#114;&#118;&#x69;&#x63;&#x65;</a><br>对应的main函数在hardware&#x2F;interfaces&#x2F;camera&#x2F;provider&#x2F;2.4&#x2F;default&#x2F;service.cpp</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// The camera HAL may communicate to other vendor components via</span></span><br><span class="line">    <span class="comment">// /dev/vndbinder</span></span><br><span class="line">    android::ProcessState::<span class="built_in">initWithDriver</span>(<span class="string">&quot;/dev/vndbinder&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">defaultPassthroughServiceImplementation</span>&lt;ICameraProvider&gt;(<span class="string">&quot;legacy/0&quot;</span>, <span class="comment">/*maxThreads*/</span> <span class="number">6</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>initWithDriver是binder相关的初始化，会打开binder设备，mmap。<br>注意这里的ProcessState是android namespace 下面的， 也就是frameworks&#x2F;native&#x2F;libs&#x2F;binder&#x2F;include&#x2F;binder&#x2F;ProcessState.h声明的类。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">Interface</span>&gt;</span><br><span class="line">__attribute__((warn_unused_result))</span><br><span class="line"><span class="function"><span class="type">status_t</span> <span class="title">defaultPassthroughServiceImplementation</span><span class="params">(std::string name,</span></span></span><br><span class="line"><span class="params"><span class="function">                                            <span class="type">size_t</span> maxThreads = <span class="number">1</span>)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">configureRpcThreadpool</span>(maxThreads, <span class="literal">true</span>);</span><br><span class="line">    <span class="type">status_t</span> result = <span class="built_in">registerPassthroughServiceImplementation</span>&lt;Interface&gt;(name);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (result != OK) &#123;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">joinRpcThreadpool</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&#x2F;&#x2F;&#x2F;dev&#x2F;hwbinder<br>configureRpcThreadpool设置binder线程池大小，这里会打开另一个binder设备&#x2F;dev&#x2F;hwbinder，并mmap。<br>因为又初始化了一个ProcessState，但是这个ProcessState是在system&#x2F;libhwbinder&#x2F;include&#x2F;hwbinder&#x2F;ProcessState.h中声明，它的namespace是android::hardware。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">Interface</span>&gt;</span><br><span class="line">__attribute__((warn_unused_result))</span><br><span class="line"><span class="function"><span class="type">status_t</span> <span class="title">registerPassthroughServiceImplementation</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        std::string name = <span class="string">&quot;default&quot;</span>)</span> </span>&#123;</span><br><span class="line">    sp&lt;Interface&gt; service = Interface::<span class="built_in">getService</span>(name, <span class="literal">true</span> <span class="comment">/* getStub */</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">status_t</span> status = service-&gt;<span class="built_in">registerAsService</span>(name);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ICameraProvider::getService代码在out&#x2F;soong&#x2F;.intermediates&#x2F;hardware&#x2F;interfaces&#x2F;camera&#x2F;provider&#x2F;2.4&#x2F;<a href="mailto:&#x61;&#110;&#x64;&#114;&#x6f;&#x69;&#100;&#x2e;&#104;&#x61;&#114;&#100;&#119;&#x61;&#114;&#x65;&#46;&#x63;&#x61;&#x6d;&#101;&#114;&#97;&#46;&#x70;&#114;&#x6f;&#x76;&#x69;&#x64;&#101;&#x72;&#64;&#50;&#46;&#x34;&#x5f;&#x67;&#x65;&#110;&#x63;">&#x61;&#110;&#x64;&#114;&#x6f;&#x69;&#100;&#x2e;&#104;&#x61;&#114;&#100;&#119;&#x61;&#114;&#x65;&#46;&#x63;&#x61;&#x6d;&#101;&#114;&#97;&#46;&#x70;&#114;&#x6f;&#x76;&#x69;&#x64;&#101;&#x72;&#64;&#50;&#46;&#x34;&#x5f;&#x67;&#x65;&#110;&#x63;</a>++&#x2F;gen&#x2F;android&#x2F;hardware&#x2F;camera&#x2F;provider&#x2F;2.4&#x2F;CameraProviderAll.cpp</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">::<span class="function">android::sp&lt;ICameraProvider&gt; <span class="title">ICameraProvider::getService</span><span class="params">(<span class="type">const</span> std::string &amp;serviceName, <span class="type">const</span> <span class="type">bool</span> getStub)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">using</span> ::android::hardware::defaultServiceManager;</span><br><span class="line">    <span class="keyword">using</span> ::android::hardware::details::waitForHwService;</span><br><span class="line">    <span class="keyword">using</span> ::android::hardware::getPassthroughServiceManager;</span><br><span class="line">    <span class="keyword">using</span> ::android::hardware::Return;</span><br><span class="line">    <span class="keyword">using</span> ::android::sp;</span><br><span class="line">    <span class="keyword">using</span> Transport = ::android::hidl::manager::V1_0::IServiceManager::Transport;</span><br><span class="line"></span><br><span class="line">    sp&lt;ICameraProvider&gt; iface = <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">const</span> sp&lt;::android::hidl::manager::V1_0::IServiceManager&gt; sm = <span class="built_in">defaultServiceManager</span>();</span><br><span class="line">    <span class="keyword">if</span> (sm == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">        <span class="built_in">ALOGE</span>(<span class="string">&quot;getService: defaultServiceManager() is null&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Return&lt;Transport&gt; transportRet = sm-&gt;<span class="built_in">getTransport</span>(ICameraProvider::descriptor, serviceName);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!transportRet.<span class="built_in">isOk</span>()) &#123;</span><br><span class="line">        <span class="built_in">ALOGE</span>(<span class="string">&quot;getService: defaultServiceManager()-&gt;getTransport returns %s&quot;</span>, transportRet.<span class="built_in">description</span>().<span class="built_in">c_str</span>());</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    Transport transport = transportRet;</span><br><span class="line">    <span class="type">const</span> <span class="type">bool</span> vintfHwbinder = (transport == Transport::HWBINDER);</span><br><span class="line">    <span class="type">const</span> <span class="type">bool</span> vintfPassthru = (transport == Transport::PASSTHROUGH);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (getStub || vintfPassthru || vintfLegacy) &#123;<span class="comment">//getStub == true</span></span><br><span class="line">        <span class="type">const</span> sp&lt;::android::hidl::manager::V1_0::IServiceManager&gt; pm = <span class="built_in">getPassthroughServiceManager</span>();</span><br><span class="line">        <span class="keyword">if</span> (pm != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">            Return&lt;sp&lt;::android::hidl::base::V1_0::IBase&gt;&gt; ret = </span><br><span class="line">                    pm-&gt;<span class="built_in">get</span>(ICameraProvider::descriptor, serviceName);</span><br><span class="line">            <span class="keyword">if</span> (ret.<span class="built_in">isOk</span>()) &#123;</span><br><span class="line">                sp&lt;::android::hidl::base::V1_0::IBase&gt; baseInterface = ret;</span><br><span class="line">                <span class="keyword">if</span> (baseInterface != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">                    iface = ICameraProvider::<span class="built_in">castFrom</span>(baseInterface);</span><br><span class="line">                    <span class="keyword">if</span> (!getStub || trebleTestingOverride) &#123;</span><br><span class="line">                        iface = <span class="keyword">new</span> <span class="built_in">BsCameraProvider</span>(iface);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> iface;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>getService实际上返回了ICameraProvider实例。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">::<span class="function">android::<span class="type">status_t</span> <span class="title">ICameraProvider::registerAsService</span><span class="params">(<span class="type">const</span> std::string &amp;serviceName)</span> </span>&#123;</span><br><span class="line">    ::android::hardware::details::<span class="built_in">onRegistration</span>(<span class="string">&quot;android.hardware.camera.provider@2.4&quot;</span>, <span class="string">&quot;ICameraProvider&quot;</span>, serviceName);</span><br><span class="line"></span><br><span class="line">    <span class="type">const</span> ::android::sp&lt;::android::hidl::manager::V1_0::IServiceManager&gt; sm</span><br><span class="line">            = ::android::hardware::<span class="built_in">defaultServiceManager</span>();</span><br><span class="line">    ::android::hardware::Return&lt;<span class="type">bool</span>&gt; ret = sm-&gt;<span class="built_in">add</span>(serviceName.<span class="built_in">c_str</span>(), <span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">return</span> ret.<span class="built_in">isOk</span>() &amp;&amp; ret ? ::android::OK : ::android::UNKNOWN_ERROR;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从sm-&gt;add 的代码来看，什么都没做。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Return&lt;<span class="type">bool</span>&gt; <span class="title">add</span><span class="params">(<span class="type">const</span> hidl_string&amp; <span class="comment">/* name */</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">                 <span class="type">const</span> sp&lt;IBase&gt;&amp; <span class="comment">/* service */</span>)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">    <span class="built_in">LOG</span>(FATAL) &lt;&lt; <span class="string">&quot;Cannot register services with passthrough service manager.&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>暂时不理解passthrough是什么意思。<br>回到defaultPassthroughServiceImplementation，最后要调用joinRpcThreadpool。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">joinBinderRpcThreadpool</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    IPCThreadState::<span class="built_in">self</span>()-&gt;<span class="built_in">joinThreadPool</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">IPCThreadState::joinThreadPool</span><span class="params">(<span class="type">bool</span> isMain)</span><span class="comment">//isMain == true</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    mOut.<span class="built_in">writeInt32</span>(isMain ? BC_ENTER_LOOPER : BC_REGISTER_LOOPER);</span><br><span class="line"></span><br><span class="line">    <span class="type">status_t</span> result;</span><br><span class="line">    <span class="comment">//这个循环会不断从binder读取命令并执行</span></span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="built_in">processPendingDerefs</span>();</span><br><span class="line">        <span class="comment">// now get the next command to be processed, waiting if necessary</span></span><br><span class="line">        result = <span class="built_in">getAndExecuteCommand</span>();</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">while</span> (result != -ECONNREFUSED &amp;&amp; result != -EBADF);</span><br><span class="line">    mOut.<span class="built_in">writeInt32</span>(BC_EXIT_LOOPER);</span><br><span class="line">    <span class="built_in">talkWithDriver</span>(<span class="literal">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以上，ICameraProvider的Server端就启动完成了。<br>似乎registerPassthroughServiceImplementation好像没什么用啊。</p>
<p>具体的实现在hardware&#x2F;interfaces&#x2F;camera&#x2F;provider&#x2F;2.4&#x2F;default&#x2F;CameraProvider.cpp。</p>
<p>再详细看一下getService的逻辑</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (getStub || vintfPassthru || vintfLegacy) &#123;<span class="comment">//getStub == true</span></span><br><span class="line">        <span class="type">const</span> sp&lt;::android::hidl::manager::V1_0::IServiceManager&gt; pm = <span class="built_in">getPassthroughServiceManager</span>();</span><br><span class="line">        <span class="keyword">if</span> (pm != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">            Return&lt;sp&lt;::android::hidl::base::V1_0::IBase&gt;&gt; ret = </span><br><span class="line">                    pm-&gt;<span class="built_in">get</span>(ICameraProvider::descriptor, serviceName);</span><br><span class="line">            <span class="keyword">if</span> (ret.<span class="built_in">isOk</span>()) &#123;</span><br><span class="line">                sp&lt;::android::hidl::base::V1_0::IBase&gt; baseInterface = ret;</span><br><span class="line">                <span class="keyword">if</span> (baseInterface != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">                    iface = ICameraProvider::<span class="built_in">castFrom</span>(baseInterface);</span><br><span class="line">                    <span class="keyword">if</span> (!getStub || trebleTestingOverride) &#123;</span><br><span class="line">                        iface = <span class="keyword">new</span> <span class="built_in">BsCameraProvider</span>(iface);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">const</span> <span class="type">char</span>* <span class="title">ICameraProvider::descriptor</span><span class="params">(<span class="string">&quot;android.hardware.camera.provider@2.4::ICameraProvider&quot;</span>)</span></span>;</span><br></pre></td></tr></table></figure>
<p>这是getStub&#x3D;&#x3D;true的情况，</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">sp&lt;IServiceManager1_0&gt; <span class="title">getPassthroughServiceManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">getPassthroughServiceManager1_1</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">sp&lt;IServiceManager1_1&gt; <span class="title">getPassthroughServiceManager1_1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="type">static</span> sp&lt;PassthroughServiceManager&gt; <span class="title">manager</span><span class="params">(<span class="keyword">new</span> PassthroughServiceManager())</span></span>;</span><br><span class="line">    <span class="keyword">return</span> manager;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>getPassthroughServiceManager返回了一个PassthroughServiceManager的实例。</p>
<p>serviceName是”legacy&#x2F;0”。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">Return&lt;sp&lt;IBase&gt;&gt; <span class="built_in">get</span>(<span class="type">const</span> hidl_string&amp; fqName,</span><br><span class="line">                      <span class="type">const</span> hidl_string&amp; name) <span class="keyword">override</span> &#123;</span><br><span class="line">    sp&lt;IBase&gt; ret = <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">openLibs</span>(fqName, [&amp;](<span class="type">void</span>* handle, <span class="type">const</span> std::string &amp;lib, <span class="type">const</span> std::string &amp;sym) &#123;</span><br><span class="line">        IBase* (*generator)(<span class="type">const</span> <span class="type">char</span>* name);</span><br><span class="line">        *(<span class="type">void</span> **)(&amp;generator) = <span class="built_in">dlsym</span>(handle, sym.<span class="built_in">c_str</span>());</span><br><span class="line">        <span class="keyword">if</span>(!generator) &#123;</span><br><span class="line">            <span class="type">const</span> <span class="type">char</span>* error = <span class="built_in">dlerror</span>();</span><br><span class="line">            <span class="built_in">LOG</span>(ERROR) &lt;&lt; <span class="string">&quot;Passthrough lookup opened &quot;</span> &lt;&lt; lib</span><br><span class="line">                       &lt;&lt; <span class="string">&quot; but could not find symbol &quot;</span> &lt;&lt; sym &lt;&lt; <span class="string">&quot;: &quot;</span></span><br><span class="line">                       &lt;&lt; (error == <span class="literal">nullptr</span> ? <span class="string">&quot;unknown error&quot;</span> : error);</span><br><span class="line">            <span class="built_in">dlclose</span>(handle);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ret = (*generator)(name.<span class="built_in">c_str</span>());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ret == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">            <span class="built_in">dlclose</span>(handle);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>; <span class="comment">// this module doesn&#x27;t provide this instance name</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">registerReference</span>(fqName, name);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用openLibs传入了一个lambda函数。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//fqName == &quot;android.hardware.camera.provider@2.4::ICameraProvider&quot;</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">openLibs</span><span class="params">(<span class="type">const</span> std::string&amp; fqName,</span></span></span><br><span class="line"><span class="params"><span class="function">            std::function&lt;<span class="type">bool</span> <span class="comment">/* continue */</span>(<span class="type">void</span>* <span class="comment">/* handle */</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">                <span class="type">const</span> std::string&amp; <span class="comment">/* lib */</span>, <span class="type">const</span> std::string&amp; <span class="comment">/* sym */</span>)&gt; eachLib)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//fqName looks like android.hardware.foo@1.0::IFoo</span></span><br><span class="line">        <span class="type">size_t</span> idx = fqName.<span class="built_in">find</span>(<span class="string">&quot;::&quot;</span>);</span><br><span class="line"></span><br><span class="line">        std::string packageAndVersion = fqName.<span class="built_in">substr</span>(<span class="number">0</span>, idx);<span class="comment">//&quot;android.hardware.camera.provider@2.4&quot;</span></span><br><span class="line">        std::string ifaceName = fqName.<span class="built_in">substr</span>(idx + <span class="built_in">strlen</span>(<span class="string">&quot;::&quot;</span>));<span class="comment">//&quot;ICameraProvider&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="type">const</span> std::string prefix = packageAndVersion + <span class="string">&quot;-impl&quot;</span>;</span><br><span class="line">    <span class="comment">//&quot;android.hardware.camera.provider@2.4-impl&quot;</span></span><br><span class="line">        <span class="type">const</span> std::string sym = <span class="string">&quot;HIDL_FETCH_&quot;</span> + ifaceName;<span class="comment">//&quot;HIDL_FETCH_ICameraProvider&quot;</span></span><br><span class="line">        <span class="comment">//#define RTLD_LAZY     0x00001</span></span><br><span class="line">        <span class="type">const</span> <span class="type">int</span> dlMode = RTLD_LAZY;</span><br><span class="line">        <span class="type">void</span> *handle = <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">dlerror</span>(); <span class="comment">// clear</span></span><br><span class="line"></span><br><span class="line">        std::vector&lt;std::string&gt; paths = &#123;HAL_LIBRARY_PATH_ODM, HAL_LIBRARY_PATH_VENDOR,</span><br><span class="line">                                          HAL_LIBRARY_PATH_VNDK_SP, HAL_LIBRARY_PATH_SYSTEM&#125;;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> LIBHIDL_TARGET_DEBUGGABLE</span></span><br><span class="line">        <span class="type">const</span> <span class="type">char</span>* env = std::<span class="built_in">getenv</span>(<span class="string">&quot;TREBLE_TESTING_OVERRIDE&quot;</span>);</span><br><span class="line">        <span class="type">const</span> <span class="type">bool</span> trebleTestingOverride = env &amp;&amp; !<span class="built_in">strcmp</span>(env, <span class="string">&quot;true&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (trebleTestingOverride) &#123;</span><br><span class="line">            <span class="type">const</span> <span class="type">char</span>* vtsRootPath = std::<span class="built_in">getenv</span>(<span class="string">&quot;VTS_ROOT_PATH&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (vtsRootPath &amp;&amp; <span class="built_in">strlen</span>(vtsRootPath) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="type">const</span> std::string halLibraryPathVtsOverride =</span><br><span class="line">                    std::<span class="built_in">string</span>(vtsRootPath) + HAL_LIBRARY_PATH_SYSTEM;</span><br><span class="line">                paths.<span class="built_in">push_back</span>(halLibraryPathVtsOverride);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">const</span> std::string&amp; path : paths) &#123;</span><br><span class="line">            std::vector&lt;std::string&gt; libs = <span class="built_in">search</span>(path, prefix, <span class="string">&quot;.so&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">const</span> std::string &amp;lib : libs) &#123;</span><br><span class="line">                <span class="type">const</span> std::string fullPath = path + lib;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (path != HAL_LIBRARY_PATH_SYSTEM) &#123;</span><br><span class="line">                    handle = <span class="built_in">android_load_sphal_library</span>(fullPath.<span class="built_in">c_str</span>(), dlMode);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    handle = <span class="built_in">dlopen</span>(fullPath.<span class="built_in">c_str</span>(), dlMode);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (handle == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">                    <span class="type">const</span> <span class="type">char</span>* error = <span class="built_in">dlerror</span>();</span><br><span class="line">                    <span class="built_in">LOG</span>(ERROR) &lt;&lt; <span class="string">&quot;Failed to dlopen &quot;</span> &lt;&lt; lib &lt;&lt; <span class="string">&quot;: &quot;</span></span><br><span class="line">                               &lt;&lt; (error == <span class="literal">nullptr</span> ? <span class="string">&quot;unknown error&quot;</span> : error);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (!<span class="built_in">eachLib</span>(handle, lib, sym)) &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>openLibs主要就是在一些路径下面搜索<a href="mailto:&#97;&#110;&#100;&#x72;&#x6f;&#105;&#x64;&#46;&#104;&#x61;&#x72;&#100;&#x77;&#97;&#114;&#x65;&#46;&#x63;&#x61;&#109;&#101;&#x72;&#x61;&#46;&#112;&#114;&#x6f;&#x76;&#x69;&#100;&#x65;&#x72;&#x40;&#50;&#x2e;&#52;&#45;&#105;&#109;&#112;&#108;&#46;&#x73;&#111;">&#97;&#110;&#100;&#x72;&#x6f;&#105;&#x64;&#46;&#104;&#x61;&#x72;&#100;&#x77;&#97;&#114;&#x65;&#46;&#x63;&#x61;&#109;&#101;&#x72;&#x61;&#46;&#112;&#114;&#x6f;&#x76;&#x69;&#100;&#x65;&#x72;&#x40;&#50;&#x2e;&#52;&#45;&#105;&#109;&#112;&#108;&#46;&#x73;&#111;</a>，找到后打开，然后回调上面传入的lambda函数。<br>大概的意思是<br>通过dlopen打开动态库并拿到句柄，通过dlsym找到HIDL_FETCH_ICameraProvider函数的地址，然后调用这个函数，传入的参数是”legacy&#x2F;0”。<br>hardware&#x2F;interfaces&#x2F;camera&#x2F;provider&#x2F;2.4&#x2F;default&#x2F;CameraProvider.cpp</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">ICameraProvider* <span class="title">HIDL_FETCH_ICameraProvider</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* name)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strcmp</span>(name, kLegacyProviderName) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    CameraProvider* provider = <span class="keyword">new</span> <span class="built_in">CameraProvider</span>();</span><br><span class="line">    <span class="keyword">return</span> provider;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>创建CameraProvider， 初始化然后返回它。<br>所以ICameraProvider::getService在通过PassthroughServiceManager的get函数得到的是一个CameraProvider实例。最后再cast。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iface = ICameraProvider::<span class="built_in">castFrom</span>(baseInterface);</span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">::android::hardware::Return&lt;::android::sp&lt;ICameraProvider&gt;&gt; ICameraProvider::<span class="built_in">castFrom</span>(<span class="type">const</span> ::android::sp&lt;::android::hidl::base::V1_0::IBase&gt;&amp; parent, <span class="type">bool</span> emitError) &#123;</span><br><span class="line">    <span class="keyword">return</span> ::android::hardware::details::<span class="built_in">castInterface</span>&lt;ICameraProvider, ::android::hidl::base::V1_0::IBase, BpHwCameraProvider&gt;(</span><br><span class="line">            parent, <span class="string">&quot;android.hardware.camera.provider@2.4::ICameraProvider&quot;</span>, emitError);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> IChild, <span class="keyword">typename</span> IParent, <span class="keyword">typename</span> BpChild&gt;</span><br><span class="line">Return&lt;sp&lt;IChild&gt;&gt; <span class="built_in">castInterface</span>(sp&lt;IParent&gt; parent, <span class="type">const</span> <span class="type">char</span>* childIndicator, <span class="type">bool</span> emitError) &#123;</span><br><span class="line">   <span class="keyword">if</span> (parent-&gt;<span class="built_in">isRemote</span>()) &#123;<span class="comment">//false</span></span><br><span class="line">        <span class="comment">// binderized mode. Got BpChild. grab the remote and wrap it.</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">sp</span>&lt;IChild&gt;(<span class="keyword">new</span> <span class="built_in">BpChild</span>(<span class="built_in">toBinder</span>&lt;IParent&gt;(parent)));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Passthrough mode. Got BnChild and BsChild.</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">sp</span>&lt;IChild&gt;(<span class="built_in">static_cast</span>&lt;IChild *&gt;(parent.<span class="built_in">get</span>()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>CameraProvider的指针static_cast为ICameraProvider指针。</p>
<p>Frameworks层的CameraService会调用ICameraProvider的接口，其服务端的实现就是CameraProvider。</p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>ICameraProvider启动会打开binder设备，并且进入循环，从binder中读取Client端发来的命令并且执行，它的业务逻辑的实现在CameraProvider中，Client端就是Frameworks的CameraService进程。CameraService在启动时会getI到CameraProvider的代理保存在ProviderInfo中。</p>

    </div>

    
    
    

    <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2019/03/16/Camera2-preview/" rel="prev" title="Camera2 preview">
                  <i class="fa fa-angle-left"></i> Camera2 preview
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2019/08/07/GLSurfaceView%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/" rel="next" title="GLSurfaceView源码阅读">
                  GLSurfaceView源码阅读 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2023</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Guo Xf</span>
  </div>
  <div class="powered-by">تطبيق الموقع <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  






  





</body>
</html>
